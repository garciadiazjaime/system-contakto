{% extends 'layout/base.html' %}
{% load fe_extras %}

{% block side_content %}
	{% if request.user.is_superuser or request.user.is_staff %}
	{% include 'sections/reportes/seccion/search_sidebar.html' %}
	{% endif %}
{% endblock %}

{% block extra_javascript %}
var ajaxloader = $("<img class=\"ajax_loader\" src=\"/media/ajax-loader.gif\" />");
{% endblock %}

{% block site_wrapper %}
<div ng-controller="ReporteCTRL">
	<div class="page-header">
		<h3>{% if compania and contacto %}
				Reporte de 
				{% if compania %} 
					{{compania}} 
				{% endif %} 
				{% if contacto %}
					<small>{{contacto}}</small>
				{% endif %}
			{% endif %}
		</h3>
		{% if contacto_id and investigaciones|length %}
		<div class="form-group pull-right" id="panel_enviar_reporte">
			<span id="msg_enviar_reporte"></span>
			<a href="" class="btn btn-default" ng-click="send_email_reporte()">Enviar Reporte</a>
		</div>
		{% endif %}
	</div>
	{% if dest_list and contacto_id and investigaciones|length %}
		<div class="row">
			<div class="col-md-6 col-md-offset-6">
				<div class="alert alert-warning">
					<p>El reporte se enviará a las siguientes direcciones:</p>
					<ul>
						{% for d in dest_list %}
							<li><strong>{{d}}</strong> {% if forloop.last %}(admin){% elif not forloop.first and not forloop.last %}(agente){% endif %}</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	{% endif %}
	<div class="row placeholders">
		{% if request.user.is_superuser or request.user.is_staff %}
		<form role="form" action="#" method="post">
		{% endif %}
				{% csrf_token %}
				{% if request.user.is_superuser or request.user.is_staff %}
				<div id="msg"></div>
				<div class="panel panel-default panel-enviar-correo">
					<div class="panel-heading">
						<h3 class="panel-title">Enviar Reporte</h3>
					</div>
					<div class="panel-body">
						<div class="col-md-10">
							<textarea rows="4" name="destinatarios"></textarea>
						</div>
						<div class="col-md-2">
							<input type="submit" class="btn btn-default" value="Enviar" />
						</div>
					</div>
				</div>
				{% endif %}
	    <div class="table-responsive">
			{% if investigaciones|length %}
			<table class="table-estatus table table-striped uppercase">
				<thead>
					<tr>
						<th class="col-red" colspan="6">Datos de Solicitud</th>
						<th class="col-gray" colspan="3">Datos de Candidato</th>
						<th class="col-blue" colspan="4">Resultado</th>
						<th class="col-red" colspan="3">Datos de Entrevista</th>
					</tr>
					<tr>
						<th class="col-red"></th>
						<th class="col-red">Contacto</th>
						<th class="col-red">Correo</th>
						<th class="col-red">Cliente</th>
						<th class="col-red">Fecha de Recibido</th>
						<th class="col-red">Tipo Estudio</th>

						<th class="col-gray">Nombre</th>
						<th class="col-gray">Puesto</th>
						<th class="col-gray">Ciudad y Estado</th>

						<th class="col-blue">Estatus</th>
						<th class="col-blue">Investigación Laboral</th>
						<th class="col-blue">Calificación Final</th>
						<th class="col-blue">Observaciones</th>

						<th class="col-red">Gestor</th>
						<th class="col-red">Día Cita</th>
						<th class="col-red">Hora Cita</th>
					</tr>
				</thead>
				<tbody>
					{% for inv in investigaciones %}
					<tr>
						<td>
							{% if request.user.is_superuser or request.user.is_staff %}
							<input type="checkbox" name="investigacion[]" value="{{inv.id}}" />
							{% endif %}
						</td>
						<td>{{ inv.contacto }}</td>
						<td>{{ inv.contacto.email }}</td>
						<td>{{ inv.compania.nombre }}</td>
						<td>{{ inv.fecha_recibido|date:"d/M/y" }}</td>
						<td>{{ inv.tipo_investigacion_status|tipo_investigacion_status }}</td>

						<td>{{ inv.candidato.nombre }} {{ inv.candidato.apellido }}</td>
						<td>{{ inv.puesto }}</td>
						<td>{{ inv.ciudad }}, {{ inv.estado }}</td>

						<td>{{ inv.status|investigacion_status }}</td>
						<td class="text-left">
							{% for t in inv.trayectoria %}
								{% if t.puesto_final or t.periodo_alta or t.periodo_baja or t.motivo_salida or t.observaciones_generales or t.opinion_rh or t.opinion_jefe %}
								<table class="estatus-trayectoria table table-striped uppercase">
									<th colspan="2">{{t.compania}}</th>
									{% if t.puesto_final %}
									<tr>
										<td>Puesto</td>
										<td>{{t.puesto_final}}</td>
									</tr>
									{% endif %}
									{% if t.periodo_alta or t.periodo_baja %}
									<tr>
										<td>Periodos</td>
										<td>{{t.periodo_alta|default:""}}-{{t.periodo_baja|default:""}}</td>
									</tr>
									{% endif %}
									{% if t.motivo_salida %}
									<tr>
										<td>Motivo de baja</td>
										<td>{{t.motivo_salida}}</td>
									</tr>
									{% endif %}
									{% if t.observaciones_generales %}
									<tr>
										<td>Observaciones</td>
										<td>{{t.observaciones_generales}}</td>
									</tr>
									{% endif %}

									{% if t.opinion_rh %}
									<tr>
										<td>Referente</td>
										<td>
											{% if t.opinion_rh.nombre %}
											Nombre: <br />
											<b>{{t.opinion_rh.nombre}}</b>
											{% endif %}
											{% if t.opinion_rh.puesto %}
											Puesto: <br />
											<b>{{t.opinion_rh.puesto}}</b>
											{% endif %}
										</td>
									</tr>
									{% endif %}
									{% if t.opinion_jefe %}
									<tr>
										<td>Referente</td>
										<td>
											{% if t.opinion_jefe.nombre %}
											Nombre: <br />
											<b>{{t.opinion_jefe.nombre}}</b>
											{% endif %}
											{% if t.opinion_jefe.puesto %}
											Puesto: <br />
											<b>{{t.opinion_jefe.puesto}}</b>
											{% endif %}
										</td>
									</tr>
									{% endif %}
								</table>
								{% endif %}
							{% endfor %}
						</td>
						<td>{{ inv.resultado|investigacion_resultado }}</td>
						<td>{{ inv.tipo_investigacion_texto }}</td>

						<td>{{inv.entrevista.entrevistador}}</td>
						<td>{{inv.entrevista.fecha_entrevista|default:""}}</td>
						<td>{{inv.entrevista.hora_entrevista|default:""}}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		{% else %}
			<div class="bg-info">0 resultados, favor de intentar con otros filtros</div>
		{% endif %}
		</div>
		{% if request.user.is_superuser or request.user.is_staff %}
		</form>
		{% endif %}
	</div>
</div>
{% include 'sections/candidato/seccion/empresa_select_modal.html' %}
{% endblock %}
